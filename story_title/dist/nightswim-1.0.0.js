!function(e){var n={};function t(o){if(n[o])return n[o].exports;var i=n[o]={i:o,l:!1,exports:{}};return e[o].call(i.exports,i,i.exports,t),i.l=!0,i.exports}t.m=e,t.c=n,t.d=function(e,n,o){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:o})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(t.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var i in e)t.d(o,i,function(n){return e[n]}.bind(null,i));return o},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="/",t(t.s=0)}([function(e,n,t){"use strict";t.r(n);var o,i,c=1,s=function(e){var n,t,i,s,a,r,l=!1,u=!1,d=!1,h={buttonTxt:"none",strt:0,end:0,lngth:0},v={objID:"none",strt:0,end:0,lngth:0};do{if(l=!1,u||(t=e.search(/\[{2}/),i=e.search(/\]{2}/)+2,t>-1&&i>1&&i>t?(s=i-t,a=e.substr(t,s),h.end=a.search(/->/),h.end>-1?(l=!0,v.strt=h.end+2,h.lngth=h.end-2,v.end=a.search(/\]{2}/),v.lngth=v.end-v.strt,h.buttonTxt=a.substr(2,h.lngth),v.objID=a.substr(v.strt,v.lngth),f?_(h.buttonTxt,v.objID,"changeLoc","no",-1):S(h.buttonTxt,v.objID,"changeLoc","no",-1),e=e.replace(a,"")):u=!0):u=!0),!d)if(n=!1,t=e.search(/\{{2}/),i=e.search(/\}{2}/)+2,t>-1&&i>1&&i>t){var p=!1;if(l=!0,s=i-t,a=e.substr(t,s),h.strt=2,2===a.search(/\!/)&&(n=!0,h.strt+=1),a.search(/\@/)===s-3&&(p=!0,r=""),h.end=a.search(/->/),-1===h.end||void 0===h.end?(h.end=a.search(/\}{2}/),p&&(h.end-=1),h.lngth=h.end-h.strt,v.objID=a.substr(h.strt,h.lngth)):(v.strt=h.end+2,v.end=a.search(/\}{2}/),p&&(v.end-=1),v.lngth=v.end-v.strt,v.objID=a.substr(v.strt,v.lngth)),h.lngth=h.end-h.strt,h.buttonTxt=a.substr(h.strt,h.lngth),f){var g=he.get(v.objID),y=fe.get(v.objID);void 0!==y&&(g=y),void 0!==g&&("player"!==g.loc?(r=h.buttonTxt,j(v.objID)):r="")}else p?S(h.buttonTxt,v.objID,n?"directAction":"openMenu","no",-1):(o="inlBtn"+c,c+=1,r=m?'<a href="#" id='+o+' class="useOn">'+h.buttonTxt+"</a>":'<a href="#" id='+o+">"+h.buttonTxt+"</a>",S("inline_button",v.objID,n?"directAction":"openMenu",o,-1));e=e.replace(a,r)}else d=!0}while(l);return e},a=function(e){var n=[];return e.forEach((function(e){var t,i,a,r,l,u,d,f=e.sectionHTML,h=!1,v=!1;if(e.conditions.length>0&&(a=f.search(/\({2}/),r=f.search(/\){2}/),a>-1&&r>1&&r>a?(l=(r+=2)-a,t=f.substr(a,l),l=(r-=2)-(a+=2),u=f.substr(a,l)):(u=f,t=f,h=!0),sn(e.conditions)?f=f.replace(t,u):(f=f.replace(t,""),h&&(v=!0,void 0!==e.fallback&&""!==e.fallback&&(f=e.fallback)))),e.consequences.length>0&&!v){var p,g=!1;if(a=-1,r=-1,a=f.search(/\(\{/),r=f.search(/\}\)/),a>-1&&r>1&&r>a?(l=(r+=2)-a,(i=f.substr(a,l)).search(/\@/)===l-3&&(g=!0,r-=1),l=(r-=2)-(a+=2),d=f.substr(a,l)):(d=f,i=f),d.length>0)if(g)f=f.replace(i,""),S(d,e.consequences,"directChange","no",-1);else o="inlBtn"+c,c+=1,p='<a href="#" id='+o+">"+d+"</a>",f=f.replace(i,p),S("inline_button",e.consequences,"directChange",o,-1)}f=s(f);var y=0;void 0!==e.delay&&"number"==typeof e.delay&&e.delay>0&&(y=e.delay);var m={sectionHTML:f,delay:y};n.push(m)})),n},r={},l=function(e){var n,t,o=!1,i=!1,c=Ge.eventID;Ke(),f&&E(),Ge.inScene=!0,Ke(),G("text"),G("choices");var a=r[e].consequences;if(an(a),Ge.eventID===c){if((n=r[e].responses).length>0){for(var l,u=0;u<n.length&&!o;)void 0!==(l=n[u].conditions)?sn(l,!1)&&(t=n[u],o=!0):o=!0,u+=1;if(o){setTimeout((function(){W("text",s(t.response),0,Ge.locationNext)}),P),"string"==typeof t.response&&""!==t.response&&(i=!0);var d=t.newChoices;if(0===d.length&&i){var h=Ge.locationNext;S("Continue",h,"changeLoc",h),setTimeout((function(){B()}),P)}else d.forEach((function(e){r[e].enabled&&S(r[e].choice,e,"advanceScene",e)})),setTimeout((function(){B()}),P);setTimeout((function(){V("text"),V("choices")}),P)}}if(n.length<1||!o)"In scene"===de.get(Ge.location).name&&Ze(Ge.locationNext)}},u=[],d=!1,f=!1,h="none",v=[],p=[],g=[],y=!1,m=!1,b=1,k=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},S=function(e,n,t,o,i){void 0===o&&(o="no"),void 0===i&&(i=-1),u.push([e,n,t,o,i])},_=function(e,n,t,o,i){void 0===o&&(o="no"),void 0===i&&(i=-1),g.push([e,n,t,o,i])},x=function(e){p.push(e)},j=function(e){var n=me(e).ref;if(n.interactions.length>0){var t=0,o=!1;n.interactions.forEach((function(n){"take"===n.type&&n.activated&&(o=!0,_(n.button,e,"interact","no",t)),t+=1})),o||(t=0,n.interactions.forEach((function(o){"talk"===o.type&&(void 0===n.sceneQueue||n.sceneQueue.length<=0||Ge.inScene)||!o.activated||_(o.button,e,"interact","no",t),t+=1})))}},I=function(e){"string"==typeof e&&(h=e)},w=function(e){$(e.target).closest("#menu_container").length||f&&E()},T=function(e,n){for(var t=!1,o=me(n),i=!1,c=0,a=0;c<v.length;){if(v[c]===n){t=!0;var r=v.length-1;if(c<r){var l=c+1,u=r-c;v.splice(l,u)}}c+=1}for(t||v.push(n);a<o.ref.interactions.length;){if("close"===o.ref.interactions[a].type){i=!0;break}a+=1}if(v.length>1){var d=v.length-2,f=v[d];i||(f===Ge.inventory.name?_("Back",f,"openInventory","no",-1):_("Back",f,"openMenu","no",-1))}e>0&&(G("menu_info",e),G("menu_options",e)),setTimeout((function(){W("menu_options","",0),W("menu_title",h,0),W("menu_info","",0),p.forEach((function(e){$("#menu_info").append("<p>"+s(e)+"</p>")})),_("Close menu","closeButton","hideMenu"),B(),Ke(),e>0&&(V("menu_info",e),V("menu_options",e))}),e)},C=function(e){T(P/4,e)},O=function(e){f=!0,y=!0,Z(!1,!0),T(0,e),$("#menu_container").removeClass("hide"),setTimeout((function(){$("#menu_container").addClass("animate"),$("#container").addClass("blur")}),50),setTimeout((function(){document.addEventListener("mouseup",w),y=!1}),500)},E=function(){if(y=!0,document.removeEventListener("mouseup",w),$("#menu_container").removeClass("animate"),$("#container").removeClass("blur"),setTimeout((function(){y=!1,f||$("#menu_container").addClass("hide")}),200),d&&(d=!1,setTimeout((function(){$("#invBtn").on("click",(function(){A()}))}),200)),v.length>1)for(var e=1;e<v.length;)me(v[e]).ref.autoClose(),e+=1;f=!1,v=[],Ke(),Ge.inObject&&!Ge.inScene?(Ge.leaveMenu(Ge.locationNext),Ke(),nn()):Ge.inObject&&Ge.inScene&&(Ge.leaveMenu("locScene"),Ke())},L=function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];m&&(m=!1,Z(!0,!0),X("'Use on' cancelled"),e&&nn())},M=function(e){var n,t=me(e).ref;n=y?250:0,setTimeout((function(){Ge.moveToMenu(e),void 0!==t&&(I(k(t.name)),x(t.descr),j(e),f?C(e):O(e))}),n)},A=function(){var e,n,t=Ge.inventory.name,o=he.get(t);d=!0,$("#invBtn").off(),n=y?250:0,setTimeout((function(){Ge.moveToMenu(t),I(k(t)),x(o.descr),Ve.forEach((function(n,t,o){n&&(e=he.get(t),_(e.name,e.name,"openMenu","no",-1))})),f?C(t):O(t),m&&L()}),n)},B=function(){var e="choices",n=u;f&&(e="menu_options",n=g),W(e,"",0),n.forEach((function(n){var t,o=n[0],c=n[1],s=n[2],a=n[3],r=n[4],u="std";t="no"===a||"string"!=typeof a?"btn"+b:a,b+=1;var d=de.get(Ge.locationNext).styling.buttonClass;void 0!==d&&"string"==typeof d&&""!==d&&(u=d),"inline_button"!==o?(o=k(o),$("#"+e).append('<li><button id="'+t+'" class="'+u+'">'+o+"</button></li>")):!m||"directAction"!==s&&"openMenu"!==s||(s="useOn"),"changeLoc"===s?$("#"+t).click((function(){L(),Ze(c)})):"advanceScene"===s?$("#"+t).one("click",(function(){L(),l(c)})):"hideMenu"===s?$("#"+t).one("click",(function(){L(),E()})):"openMenu"===s?$("#"+t).click((function(){L(),M(c)})):"openInventory"===s?$("#"+t).one("click",(function(){L(),A()})):"interact"===s?$("#"+t).click((function(){L();var e=he.get(c);void 0===e&&(e=fe.get(c)),r>=0&&e.interact(r,!1)})):"directAction"===s?$("#"+t).click((function(){L(),on(c)})):"directChange"===s?$("#"+t).click((function(){L(),an(c)})):"refreshLoc"===s?$("#"+t).one("click",(function(){L(),nn()})):"useOn"===s&&$("#"+t).one("click",(function(){var e=he.get(c);void 0===e&&(e=fe.get(c)),Z(!0,!0),e.receiveFromObj(i),m=!1,nn()}))})),f?(p=[],g=[]):u=[]},F="contain",D="no_bg",N="std",q="std",P=1e3,H=5e3,R=[],z=!0,Q=!1,U={bgClass:"std",img:"no_bg"},J={bgClass:"std",img:"no_bg"},V=function(e,n){(n<0||void 0===n)&&(n=P),$("#"+e).fadeTo(n,1)},G=function(e,n){(n<0||void 0===n)&&(n=P),$("#"+e).fadeTo(n,0)},K=function(e){var n=de.get(e);if(n instanceof ve){var t=n.styling.containerClass;void 0!==t&&""!==t&&"string"==typeof t||(t="std"),t!==q&&($("#container").removeClass(q),$("#container").addClass(t),$("#menu_container").removeClass(q),$("#menu_container").addClass(t),q=t)}},W=function(e,n,t){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"none";void 0===t&&0!==t&&(t=P),void 0!==o&&"string"==typeof o||(o="none"),t>0?(G(e,t),setTimeout((function(){$("#"+e).html(n),"none"!==o&&K(o),V(e,t)}),t)):("none"!==o&&K(o),$("#"+e).html(n))},X=function(e){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],t=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o={msg:e,persist:n,useOnMode:t};if(void 0!==e&&"string"==typeof e&&""!==e)if(R.length>0){var i=R.length-1;R[i].msg!==e&&R.push(o)}else R.push(o),Y()},Y=function e(){var n="feedback",t=R[0].msg,o=R[0].persist,i=R[0].useOnMode;f&&(n="menu_"+n),W(n,t,0),document.getElementById(n).style.opacity=1,i&&$("#cancelUseOn").one("click",(function(){L(!0)})),o||setTimeout((function(){R.splice(0,1),R.length>0?e():document.getElementById(n).style.opacity=0}),H)},Z=function(e,n){e&&(document.getElementById("feedback").style.opacity=0),n&&(document.getElementById("menu_feedback").style.opacity=0),R=[]},ee=function(e){var n="",t=!1;if(e.length>0)for(var o,i=0;i<e.length;)"no_msg"!==(o=e[i])&&(t=!0,n+=o,i<e.length-1&&(n+="<br>")),i++;t&&X(n)},ne=function(){if(!Q&&(document.fullscreenEnabled||document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled)){Q=!0,$("#fsBtn").removeClass("fs_enter"),$("#fsBtn").addClass("fs_exit");var e=document.querySelector("body");e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.msRequestFullscreen&&e.msRequestFullscreen()}else Q&&(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement)&&(Q=!1,$("#fsBtn").removeClass("fs_exit"),$("#fsBtn").addClass("fs_enter"),document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen())};function te(e){return(te="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function oe(e,n){return!n||"object"!==te(n)&&"function"!=typeof n?ce(e):n}function ie(e){return(ie=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ce(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function se(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),n&&ae(e,n)}function ae(e,n){return(ae=Object.setPrototypeOf||function(e,n){return e.__proto__=n,e})(e,n)}function re(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function le(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function ue(e,n,t){return n&&le(e.prototype,n),t&&le(e,t),e}var de=new Map,fe=new Map,he=new Map,ve=function(){function e(n,t,o,i,c,s,a,r,l){return re(this,e),this.name=t,this.accessMsg=o,this.locSnd=c,this.locImg=i,this.cutscenes=s,this.scenes=a,this.content=r,this.styling=l,this.visited=0,de.set(n,this),this}return ue(e,[{key:"setAccessMsg",value:function(e){return void 0!==e&&"string"==typeof e&&(this.accessMsg=e,!0)}},{key:"setLocImg",value:function(e){return void 0!==e&&"string"==typeof e&&(this.locImg=e,!0)}},{key:"setLocSnd",value:function(e){return void 0!==e&&"string"==typeof e&&(this.locSnd=e,!0)}},{key:"visit",value:function(){this.visited+=1}},{key:"getVisited",value:function(){return this.visited}}]),e}(),pe=function(){function e(n,t,o,i,c,s){re(this,e),this.name=n,this.descr=t,this.loc=o,this.state=i,this.interactions=c,this.receive=s}return ue(e,[{key:"setInteraction",value:function(e,n){var t=this.interactions[e].activated;return void 0!==t&&"boolean"==typeof t&&void 0!==n&&"boolean"==typeof n&&(t=n,!0)}},{key:"setDescr",value:function(e){return void 0!==e&&"string"==typeof e&&""!==e&&(this.descr=e,!0)}},{key:"setLoc",value:function(e){var n=de.get(e);return void 0!==n&&n instanceof ve&&(this.loc=e,!0)}},{key:"setState",value:function(e){return void 0!==e&&"string"==typeof e&&""!==e&&(this.state=e,!0)}},{key:"receiveFromObj",value:function(e){for(var n=0,t=!1;n<this.receive.length;){var o=this.receive[n];if(o.from===e){t=!0,sn(o.conditions,!0)&&(an(o.consequences),X(o.feedback));break}n+=1}t||X("Can't use "+e+" on "+this.name)}}]),e}(),ge=function(e){function n(e,t,o,i,c,s,a,r){var l;return re(this,n),(l=oe(this,ie(n).call(this,e,t,o,i,c,s))).comfortLevel=a,l.interactions=c,l.sceneQueue=r,fe.set(e,ce(l)),oe(l,ce(l))}return se(n,e),ue(n,[{key:"addScene",value:function(e){var n;void 0!==e&&"string"==typeof e&&(n="scenes/"+n+".json",$.get(n).done((function(){return sceneQueue.push(e),!0})).fail((function(){return We("constructor.js/addScene: scenefile not found"),!1})))}},{key:"interact",value:function(e,n){var t,o=this.interactions[e],i=this.interactions[e].conditions;void 0===n&&(n=!1),sn(i,!0)&&(an(o.consequences),"talk"===o.type?this.sceneQueue.length>0&&(t=this.sceneQueue.splice(0,1),Ye("story/scenes/"+t+".json")):(n||M(Ge.location),X(o.feedback),this.interactions.splice(e,1)))}}]),n}(pe),ye=function(e){function n(e,t,o,i,c,s,a,r){var l;return re(this,n),(l=oe(this,ie(n).call(this,e,t,o,i,c,s))).content=a,l.singleUse=r,he.set(e,ce(l)),oe(l,ce(l))}return se(n,e),ue(n,[{key:"autoClose",value:function(){for(var e=0;e<this.interactions.length;){var n=this.interactions[e];if("close"===n.type){this.state="closed",n.type="open",n.button="Open "+this.name;var t=this.descr;this.descr=this.content,this.content=t,console.log("auto-closed "+this.name)}e+=1}}},{key:"setInteraction",value:function(e,n){var t=this.interactions[e].activated;return void 0!==t&&"boolean"==typeof t&&void 0!==n&&"boolean"==typeof n&&(t=n,!0)}},{key:"interact",value:function(e,n){var t,o=this.interactions[e],c=this.interactions[e].conditions,s=!1,a=Ge.location;if(void 0===n&&(n=!1),sn(c,!0)){var r;switch(o.type){case"open":"closed"===this.state&&(this.state="open",o.type="close",o.button="Close "+this.name,r=this.descr,this.descr=this.content,this.content=r,a=this.name);break;case"close":if("open"===this.state&&(this.state="closed",o.type="open",o.button="Open "+this.name,r=this.descr,this.descr=this.content,this.content=r,v.length>1)){var l=v.length-2;a=v[l]}break;case"take":this.state="taken",this.loc="player",o.activated=!1,o.button="Put "+this.name+" back",Ve.set(this.name,!0);break;case"use on":s=!0}if(an(o.consequences),this.singleUse)for(var u=0;u<this.interactions.length;){this.interactions[u].activated=!1,u+=1}n||s?s&&(t=this.name,m=!0,i=t,E(),X('<a href="#" id="cancelUseOn">cancel</a> Use '+i+" on:",!0,!0)):a===Ge.inventory.name?openInventory():M(a),X(o.feedback)}}}]),n}(pe),me=function(e){var n,t;return(n=fe.get(e))instanceof ge?t="Npc":(n=he.get(e))instanceof ye?t="Obj":(t="unknown",n=null),{type:t,ref:n}},be=!1,ke=[],Se=[],_e=[],$e={filename:"no_sound",howl:null},xe={filename:"no_sound",howl:null},je={filename:"no_sound",howl:null},Ie="stopped",we="none",Te=1e3,Ce=function(e){_e.push(e),1===_e.length&&function e(){var n=_e[0],t=Te;if("stopped"===Ie&&"fadein"!==we&&("fadein"===n||"crossfade"===n&&"no_sound"===xe.filename))Ie="fading",we="fadein",je.howl.volume(0),je.howl.play(),je.howl.fade(0,1,Te),$("#soundInfo").text("playing "+je.filename),setTimeout((function(){Ie="playing"}),Te);else if("playing"===Ie&&"fadeout"!==we&&"fadeout"===n){var o=$e;Ie="fading",we="fadeout",$("#soundInfo").text("fading out"),"no_sound"!==o.filename&&(o.howl.fade(1,0,Te),setTimeout((function(){o.howl.pause(),Ie="stopped",$("#soundInfo").text("playback paused")}),Te))}else"playing"===Ie&&"crossfade"===n?(Ie="fading",we="crossfade",$("#soundInfo").text("crossfading"),be||je.howl.play(),xe.howl.fade(1,0,Te),je.howl.fade(0,1,Te),setTimeout((function(){xe.howl.pause(),Ie="playing",$("#soundInfo").text("playing "+je.filename)}),Te)):"update"===n&&(t=0);$e=je,setTimeout((function(){var n=_e.length,t=1;n>1&&(t=n-1),_e.splice(0,t),_e.length>0&&e()}),t)}()},Oe=function(e){xe=$e,je=e,$("#soundInfo").text("track changed: "+e.filename),be||Ce("crossfade")},Ee=function(e){de.forEach((function(n){var t=!1;if("no_sound"!==n.locSnd){for(var o=!1,i=0;i<ke.length;){if(ke[i].filename===n.locSnd){o=!0;break}i+=1}if(!o){var c="story/audio/"+n.locSnd;be||e.forEach((function(e){c===(e="story/audio/"+e)&&(t=!0,console.log("Preloading "+c))}));var s=new Howl({src:[c],loop:!0,volume:0,preload:t}),a={filename:n.locSnd,howl:s};ke.push(a)}}}))},Le=function(){be?(be=!1,je=$e,"no_sound"!==$e.filename&&("loaded"===$e.howl.state()?Ce("fadein"):($e.howl.load(),$e.howl.once("load",(function(){Ce("fadein")})))),$("#soundBtn").removeClass("sound_off"),$("#soundBtn").addClass("sound_on")):(be=!0,"no_sound"!==$e.filename&&Ce("fadeout"),$("#soundBtn").removeClass("sound_on"),$("#soundBtn").addClass("sound_off"))},Me=function(e){"number"==typeof e&&e>=0&&(Te=e)},Ae=function(e){for(var n,t=!1,o=0;o<Se.length;){if(Se[o].filename===e){t=!0,n=o;break}o+=1}if(!t){var i=/(?:\.([^.]+))?$/.exec(e)[1];if(void 0===i||"mp3"!==i&&"wav"!==i&&"ogg"!==i&&"aac"!==i&&"flac"!==i)We("soundfile format not supported"),n=-1;else{var c={};c.filename=e,c.howl=function(e,n){return be&&(n=!1),new Howl({src:[e],loop:!1,volume:1,preload:n})}(e,!0),c.howl instanceof Howl?(Se.push(c),n=o):(We("could not create new Howl sound object"),n=-1)}}return n},Be=function(e){be||void 0===Se[e]||Se[e].howl.play()},Fe=function e(n,t){var o="event_"+t.indexOf(n),i=n.duration+n.inAnim;if("no_sound"!==n.playSoundfile&&void 0!==n.soundIndex&&Be(n.soundIndex),"add"===n.type)n.inAnim>=0&&($('<div id="'+o+'" class="cutscene">'+n.sectionHTML+"</div>").appendTo("#text").hide(),$("#"+o).fadeIn(n.inAnim));else{var c='<div id="'+o+'" class="cutscene">'+n.sectionHTML+"</div>";n.inAnim>0?($("#text").css("opacity",0),$("#text").html(c),V("text",n.inAnim)):$("#text").html(c)}setTimeout((function(){n.outAnim>0?$("#"+o).fadeOut(n.outAnim):0===n.outAnim&&$("#"+o).remove(),"fadeOutAll"===n.onEnd&&W("text","",P),setTimeout((function(){var o=t.indexOf(n);o<t.length-1?e(t[o+1],t):"In scene"===de.get(Ge.location).name&&Ze(Ge.locationNext)}),n.outAnim)}),i)};function De(e){return(De="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}t.d(n,"player",(function(){return Ge})),t.d(n,"requestLocChange",(function(){return Ze})),t.d(n,"refreshLocation",(function(){return nn})),t.d(n,"loadScene",(function(){return Ye})),t.d(n,"directAction",(function(){return on})),t.d(n,"updateDebugStats",(function(){return Ke})),t.d(n,"checkConditions",(function(){return sn})),t.d(n,"change",(function(){return an})),t.d(n,"logError",(function(){return We})),t.d(n,"Inventory",(function(){return Ve}));var Ne,qe,Pe,He={},Re=!1,ze=!1,Qe=!1,Ue=!1,Je=[],Ve=new Map,Ge={name:"player",location:"none",locationPrev:"none",locationNext:"none",inObject:!1,inScene:!1,state:"normal",eventID:0,moveToMenu:function(e){Ge.locationPrev=Ge.location,Ge.location=e,Ge.inObject=!0},leaveMenu:function(e){Ge.locationPrev=Ge.location,Ge.location=e,Ge.inObject=!1},setLocation:function(e){"locScene"===Ge.location||Ge.inObject||(Ge.locationNext=Ge.location),Ge.locationPrev=Ge.location,Ge.location=e},setInObject:function(e){Ge.inObject=!!e},upEventID:function(){Ge.eventID+=1}},Ke=function(){be&&$("#soundInfo").html("muted"),$("#playereventid").html(Ge.eventID),$("#playerlocation").html(Ge.location),$("#playerprevloc").html(Ge.locationPrev),$("#playernextloc").html(Ge.locationNext),$("#inScene").html(Ge.inScene),$("#inObject").html(Ge.inObject),$("#menu_active").html(f),$("#menu_tracker").html(""),v.forEach((function(e){$("#menu_tracker").append("<li>&gt; "+e+"</li>")}))},We=function(e){console.log("ERROR: "+e),$("#err").text("Program error - see console for details")},Xe=function(e){$.getJSON(e,(function(e){!function(e){Ge.upEventID(),G("text",P),G("choices",P),e.forEach((function(e){if("no_sound"!==e.playSoundfile){var n="story/audio/"+e.playSoundfile;e.soundIndex=Ae(n)}})),Ge.setLocation("locScene"),Ge.setInObject(!1),setTimeout((function(){$("#text").html(""),$("#choices").html(""),V("text",0),V("choices",0),K(Ge.locationNext),Fe(e[0],e)}),P)}(e)})).fail((function(){We("main.js/playCutscene: scenefile not loaded: either the file doesn't exist, or there is a syntax-error in the file")}))},Ye=function(e){$.getJSON(e,(function(e){var n;n=e,Ge.setLocation("locScene"),Ge.setInObject(!1),Ge.upEventID(),r=n,l("start")})).fail((function(){We("main.js/loadScene: scenefile not loaded: either the file doesn't exist, or there is a syntax-error in the file")}))},Ze=function(e){var n=de.get(e);if(n instanceof ve)if("unlocked"!==n.accessMsg)X(n.accessMsg);else if(Je.length>0){var t=Je.length-1;Je[t]!==e&&Je.push(e)}else Je.push(e),en();else We("location with ID '"+e+"' not found")},en=function e(){Ke(),Ge.upEventID();var n,t=Je[0],o=de.get(t);Ge.inObject=!1,f&&E(),function(e){var n,t=e.locImg,o=e.styling.bgClass;(void 0!==o&&"string"==typeof o&&""!==o||(o="std"),o!==N||t!==D)&&(D=t,n="no_bg"===t?"none":"story/images/"+t,z?(o!==J.bgClass&&($("#bg_layer_bottom").removeClass(J.bgClass),$("#bg_layer_bottom").addClass(o),J.bgClass=o),t!==J.img&&("none"===n?($("#bg_layer_bottom").css("background","none"),$("#bg_layer_bottom").css({"background-color":""})):($("#bg_layer_bottom").css("background","url('"+n+"') top center no-repeat"),$("#bg_layer_bottom").css({"background-color":""}),$("#bg_layer_bottom").css("background-size",F)),J.img=t),document.getElementById("bg_layer_top").style.opacity=0,z=!1):(o!==U.bgClass&&($("#bg_layer_top").removeClass(U.bgClass),$("#bg_layer_top").addClass(o),U.bgClass=o),t!==U.img&&("none"===n?($("#bg_layer_top").css("background","none"),$("#bg_layer_top").css({"background-color":""})):($("#bg_layer_top").css("background","url('"+n+"') top center no-repeat"),$("#bg_layer_top").css({"background-color":""}),$("#bg_layer_top").css("background-size",F)),U.img=t),document.getElementById("bg_layer_top").style.opacity=1,z=!0),N=o)}(o),function(e){if(e!==$e.filename)if("no_sound"!==e){for(var n,t=!1,o=0;o<ke.length&&!t;)ke[o].filename===e&&(t=!0,n=o),o+=1;if(t&&!be){var i=ke[n];"unloaded"===i.howl.state()?(i.howl.load(),i.howl.once("load",(function(){Oe(i)}))):"loading"===i.howl.state()?i.howl.once("load",(function(){Oe(i)})):Oe(i)}else t&&be&&(je=ke[n],Ce("update"))}else je={filename:"no_sound",howl:null},be||Ce("fadeout"),Ke()}(o.locSnd),"In scene"!==o.name&&(Ge.locationNext=t),Ge.locationPrev=Ge.location,Ge.location=t,Ge.inScene=!1,o.visit();for(var i=!1,c=Object.keys(o.cutscenes),s=0;s<c.length&&!i;)n=c[s],o.cutscenes[n]&&(o.cutscenes[n]=!1,Xe("story/scenes/"+n+".json"),i=!0),s+=1;for(c=Object.keys(o.scenes),s=0;s<c.length&&!i;)n=c[s],o.scenes[n]&&(o.scenes[n]=!1,Ye("story/scenes/"+n+".json"),i=!0),s+=1;if(i)Je=[];else{var r=a(o.content);Ge.inScene=!1,G("text"),G("choices"),setTimeout((function(){var n,i="",c=[],s=0;r.forEach((function(e){void 0!==e.delay&&e.delay>0&&(n="delay_"+s,e.sectionHTML='<div id="'+n+'" class="waitForFade">'+e.sectionHTML+"</div>",c.push(e.delay),n+=1),i+=e.sectionHTML})),W("text",i,0,t),B(),V("text"),V("choices"),s=0,c.forEach((function(e){var n=s,i=t,c=o.getVisited();setTimeout((function(){Ge.location===i&&c===o.getVisited()&&(document.getElementById("delay_"+n).style.opacity=1)}),e),s+=1})),setTimeout((function(){var n=Je.length,o=1;n>1&&(o=n-1),Je.splice(0,o),Je.length>0&&Je[0]!==t&&e()}),P)}),P)}Ke()},nn=function(){var e=Ge.locationNext,n=de.get(e),t=a(n.content),o="";t.forEach((function(e){o+=e.sectionHTML})),W("text",o,0),B(),Ge.inObject=!1},tn=function(){new ve("locScene","In scene","locked","no_bg","no_sound",{},{});var e,n,t,o=Ne.startLocation;Ge.locationPrev=o,Ge.locationNext=o,document.onkeydown=function(e){var n=!1,t=!1;void 0!==(e=e||window.event).key?(n="Escape"===e.key||"Esc"===e.key,t=" "===e.key):(n=27===e.keyCode,t=32===e.keyCode),n&&f&&E(),t&&Ne.enableInventory&&(d?E():A())},Ge.inventory=new ye("Inventory","Stuff you're carrying around","player","default","<p>Choose an object:</p>",[]),Ne.enableInventory&&($("#invBtn").removeClass("hide"),$("#invBtn").addClass("inv_off"),$("#invBtn").on("click",(function(){A()}))),Ne.debugStats&&(document.getElementById("debugstats").style.display="block"),$("#soundBtn").click(Le),Ne.enableFSButton&&($("#fsBtn").removeClass("hide"),$("#fsBtn").addClass("fs_enter"),$("#fsBtn").click(ne)),document.getElementById("storyTitle").style.display="none",document.querySelector("header").style.opacity=1,He=Ne.storySettings,e=Ne.bgSize,F=e,"number"==typeof(n=Ne.fadeTime)&&n>0&&n<5e3&&(P=n),"number"==typeof(t=Ne.feedbackTime)&&t>0&&t<5e4&&(H=t);var i=2*P;setTimeout((function(){V("container",i)}),P),Ze(o)},on=function(e){var n=he.get(e);n.interactions.length>0&&("talk"===n.interactions[0].type&&(void 0===n.sceneQueue||n.sceneQueue.length<=0||Ge.inScene)||n.interact(0,!0))},cn=function(e,n,t){var o=!1;return(void 0===t||"equal"!==t&&"larger"!==t&&"smaller"!==t)&&(t="equal"),"equal"===t?e===n&&(o=!0):"larger"===t?e>n&&(o=!0):"smaller"===t&&e<n&&(o=!0),o},sn=function(e){var n,t,o,i,c,s=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],a=[],r=!0,l=[],u=0;return e.length>0&&e.forEach((function(e){var s,r=!1;switch(s=void 0!==e.failMsg&&"string"==typeof e.failMsg&&""!==e.failMsg?e.failMsg:"no_msg",n=e.type,t=e.value,void 0!==e.loc&&(o=de.get(e.loc),c=o instanceof ve?o:"no_location"),void 0!==e.npc&&(e.obj=e.npc),void 0!==e.obj&&("player"===e.obj?c=Ge:(i=me(e.obj),c=i.ref)),n){case"inInventory":Ve.has(c.name)&&(r=!0),r?a.push(!0):(a.push(!1),l[u]=s,u+=1);break;case"location":c.loc===t?a.push(!0):(a.push(!1),l[u]=s,u+=1);break;case"locationAccess":c.accessMsg===t?a.push(!0):(a.push(!1),l[u]=s,u+=1);break;case"npcComfortLevel":cn(t,c.comfortLevel,e.compare)?a.push(!0):(a.push(!1),l[u]=s,u+=1);break;case"state":c.state===t?a.push(!0):(a.push(!1),l[u]=s,u+=1);break;case"storySetting":cn(t,He[e.storySetting],e.compare)?a.push(!0):(a.push(!1),l[u]=s,u+=1);break;case"visited":"no_location"!==c&&void 0!==t&&"boolean"==typeof t?c.getVisited()>0&&t||0===c.getVisited()&&!t?a.push(!0):(a.push(!1),l[u]=s,u+=1):(a.push(!1),l[u]=s,We("invalid locID specified for visited-condition"),u+=1)}})),!(a.length>0)||(a.forEach((function(e){e||(r=!1)})),!!r||(s&&l.length>0&&ee(l),!1))},an=function(e){var n,t,o,i,c,s=[],a=0;e.forEach((function(e){var l,u=!1;switch(e.type){case"addScene":(t=fe.get(e.npc))instanceof ge&&void 0!==e.scene&&"string"==typeof e.scene&&(u=t.addScene(e.scene));break;case"changeActivation":"unknown"!==(o=me(e.obj)).type&&void 0!==e.index&&"number"==typeof e.index&&e.index>=0&&void 0!==e.value&&"boolean"==typeof e.value&&(u=o.ref.setInteraction(e.index,e.value));break;case"changeLoc":void 0!==(n=de.get(e.loc))&&n instanceof ve&&(Ze(e.loc),u=!0);break;case"changeLocAccess":void 0!==(n=de.get(e.loc))&&n instanceof ve&&(u=n.setAccessMsg(e.accessMsg));break;case"changeLocBg":void 0!==(n=de.get(e.loc))&&n instanceof ve&&(u=n.setLocImg(e.file));break;case"changeLocSound":void 0!==(n=de.get(e.loc))&&n instanceof ve&&(u=n.setLocSnd(e.file));break;case"changeNpcInteraction":(t=fe.get(e.npc))instanceof ge&&void 0!==e.interaction&&"string"==typeof e.interaction&&(t.interaction=e.interaction,u=!0);break;case"changeObjDescr":"unknown"!==(o=me(e.obj)).type&&(u=o.ref.setDescr(e.value));break;case"changeObjLoc":"unknown"!==(o=me(e.obj)).type&&(u=o.ref.setLoc(e.value));break;case"changeObjState":"unknown"!==(o=me(e.obj)).type&&(u=o.ref.setState(e.value));break;case"changePlayerState":void 0!==e.state&&"string"==typeof e.state&&(Ge.state=e.state,u=!0);break;case"changeSceneState":(n=de.get(e.loc))instanceof ve&&void 0!==e.scene&&"string"==typeof e.scene&&void 0!==e.activate&&"boolean"==typeof e.activate&&(n.scenes[e.scene]=e.activate,u=!0);break;case"setStorySetting":void 0!==He[e.storySetting]&&(He[e.storySetting]=e.value,u=!0);break;case"disableChoice":void 0!==e.choice&&"string"==typeof e.choice&&(l=choice,u=void 0!==r[l].enabled&&"boolean"==typeof r[l].enabled?(r[l].enabled=!1,!0):(console.log("Error: scene.js/disableChoice: choice not found"),!1));break;case"displayTxt":void 0!==e.txt&&"string"==typeof e.txt&&(G("container"),setTimeout((function(){W("text",e.txt,0),S("Continue","refresh","refreshLoc"),B(),V("container")}),P),u=!0);break;case"fadeOut":void 0!==e.id&&"string"==typeof e.id&&(G(e.id),u=!0);break;case"increaseNpcComfort":(t=fe.get(e.npc))instanceof ge&&void 0!==e.amount&&"number"==typeof e.amount&&(t.comfortLevel+=e.amount,u=!0);break;case"increaseStorySetting":void 0!==e.amount&&"number"==typeof e.amount&&void 0!==He[e.storySetting]&&(He[e.storySetting]+=e.amount,u=!0);break;case"playSound":void 0!==e.url&&"string"==typeof e.url&&(i="story/audio/"+e.url,(c=Ae(i))>=0&&Be(c));break;case"refresh":nn(),u=!0;break;case"removeSection":void 0!==(n=de.get(e.loc))&&void 0!==n.content[e.section]&&"object"===De(n.content[e.section])&&(n.content.splice(e.section,1),u=!0);break;case"triggerCutscene":void 0!==e.cutscene&&"string"==typeof e.cutscene&&(loadCutscene("story/scenes/"+e.scene+".json"),u=!0);break;case"triggerScene":void 0!==e.scene&&"string"==typeof e.scene&&(Ye("story/scenes/"+e.scene+".json"),u=!0)}u&&void 0!==e.feedback&&"string"==typeof e.feedback?(s[a]=e.feedback,a+=1):u||We("consequence failed: "+e.type)})),s.length>0&&ee(s)};$(document).ready((function(){console.log("This story is powered by Nightswim 1.0.0"),$.ajaxSetup({beforeSend:function(e){e.overrideMimeType&&e.overrideMimeType("application/json")}}),$.getJSON("story/obj_list.json",(function(e){$.each(e,(function(e,n){new ye(n.name,n.description,n.location,n.state,n.interactions,n.receive,n.content,n.singleUse)})),Re=!0,console.log("Obj's loaded")})).fail((function(){We("Obj's not loaded. This is probably caused by a syntax-error in obj_list.json")})),$.getJSON("story/npc_list.json",(function(e){$.each(e,(function(e,n){new ge(n.name,n.description,n.location,n.state,n.interactions,n.receive,n.comfortLevel,n.sceneQueue)})),ze=!0,console.log("Npc's loaded")})).fail((function(){We("Npc's not loaded. This is probably caused by a syntax-error in npc_list.json")})),$.getJSON("story/locations.json",(function(e){var n=setInterval((function(){Re&&ze?(clearInterval(n),$.each(e,(function(e,n){new ve(n.locID,n.name,n.accessMsg,n.locImg,n.locSnd,n.cutscenes,n.scenes,n.content,n.styling)})),Qe=!0,console.log("Locations loaded")):console.log("Not yet ready. ObjListLoaded = "+Re+", NpcListLoaded = "+ze)}),100)})).fail((function(){We("Locations not loaded. This is probably caused by a syntax-error in locations.json")})),$.getJSON("story/init.json",(function(e){Ne=e,Ue=!0})).fail((function(){We("Init settings not loaded. This is probably caused by a syntax-error in init.json")})),qe=setInterval((function(){Ue&&(clearInterval(qe),Ne.muteSound&&$("#playSound").text("Turn sound on"),$("#playSound").click((function(){Ne.muteSound?(Ne.muteSound=!1,$("#playSound").text("Turn sound off")):(Ne.muteSound=!0,$("#playSound").text("Turn sound on"))})),Ne.devAutoStart&&(qe=setInterval((function(){Qe&&Ue&&(clearInterval(qe),Ne.muteSound&&Le(),Me(Ne.audioFadeTime),Array.isArray(Ne.preLoadAudio)&&Ne.preLoadAudio.length>0&&Ne.preLoadAudio,Ee(Ne.preloadAudio),tn())}),100)))}),100),$("#startButton").one("click",(function(){Ne.devAutoStart||(qe=setInterval((function(){if(Qe&&Ue){if(clearInterval(qe),Ne.muteSound&&Le(),Me(Ne.audioFadeTime),Array.isArray(Ne.preLoadAudio)&&Ne.preLoadAudio.length>0?Ne.preLoadAudio:[],Ee(Ne.preloadAudio),!Ne.muteSound){var e=de.get(Ne.startLocation);"no_sound"!==e.locSnd&&(Pe=function(e){for(var n,t=!1,o=0;o<ke.length&&!t;)ke[o].filename===e&&(t=!0,n=o),o+=1;return t?ke[n]:null}(e.locSnd),$e=Pe,Ie="playing",$("#soundInfo").text("playing: "+$e.filename),Pe.howl.load(),console.log("Loading first audiotrack: "+Pe.filename),Pe.howl.volume(1),Pe.howl.play())}G("container",P),setTimeout(tn,P)}}),100))}))}));n.default="Main Story Module"}]);